"use client";

import React, { useState, useEffect } from "react";
import { Card } from "@/components/ui/card";
import Link from "next/link";
import { useAppContext } from "@/context/appcontext";

// 数据部分
const INTERNAL_VULNERABILITIES = [
  { id: "CVE-2017-0144", cvss: 8.1, system: "Microsoft Windows", status: "Patched" },
  { id: "CVE-2017-5638", cvss: 9.8, system: "Apache Struts 2 Framework", status: "Active" },
  { id: "CVE-2018-11776", cvss: 9.8, system: "Apache Struts", status: "Patched" },
];

const EXTERNAL_EXPLOITS = [
  { id: "CVE-2017-0144", pattern: "SMB Remote Code Execution",tool: "EternalBlue"  },
  { id: "CVE-2017-5638", pattern: "Remote Code Execution",     tool: "Exploit-Kit-X" },
  { id: "CVE-2021-44228", pattern: "Remote Code Execution",     tool: "Log4Shell Kit"  },
];

const VL_OPTS = [
  { lbl: "Very Low",  val: 0   },
  { lbl: "Low",       val: 0.2 },
  { lbl: "Moderate",  val: 0.5 },
  { lbl: "High",      val: 0.8 },
  { lbl: "Very High", val: 1   },
];

const statusColor = (s: string) =>
    s === "Patched"
    ? "bg-green-100 text-green-700"
    : s === "In Progress"
    ? "bg-yellow-100 text-yellow-700"
    : "bg-red-100 text-red-700"; // Active

export default function VulnerabilityAnalysisClient() {
  const { tefValue, settotalLef } = useAppContext();
  const [vlValues, setVlValues] = useState<{ [key: string]: number }>({
  "CVE-2017-5638": 1,      //Very High
  "CVE-2017-0144": 0.2         //  Low
});

  const [statuses, setStatuses] = useState(
    INTERNAL_VULNERABILITIES.map((v) => v.status)
  );

  const common = INTERNAL_VULNERABILITIES
    .filter(i => EXTERNAL_EXPLOITS.some(e => e.id === i.id))
    .map(i => ({ ...i, ...EXTERNAL_EXPLOITS.find(e => e.id === i.id)! }));

  const calcLEF  = (vl:number)=>vl * tefValue;
  const totalLEF = common.reduce((sum,v)=>sum + calcLEF(vlValues[v.id]??0),0);

  useEffect(()=>settotalLef(totalLEF),[totalLEF]);


  useEffect(() => {
    settotalLef(totalLEF);
  }, [totalLEF]);

  const handleVLChange = (id: string, value: number) => {
    setVlValues((prev) => ({ ...prev, [id]: value }));
  };

  return (
    <div className="flex h-screen bg-gray-900 text-white">
      {/* Sidebar */}
      <div className="w-1/4 bg-gray-800 p-6">
        <h2 className="text-2xl font-bold mb-4">Navigation</h2>
        <nav className="flex flex-col space-y-4">
          <Link href="/" className="p-3 bg-gray-700 text-gray-300 rounded-md hover:bg-gray-600">Threat Actor Analysis</Link>
          <Link href="/vulnerabilityanalysis" className="p-3 bg-blue-500 text-white rounded-md hover:bg-blue-600">Vulnerability Analysis</Link>
          <Link href="/riskanalysis" className="p-3 bg-gray-700 text-gray-300 rounded-md hover:bg-gray-600">Risk Analysis</Link>
          <Link href="/securitycontrolsanalysis" className="p-3 bg-gray-700 text-gray-300 rounded-md hover:bg-gray-600">Security Controls Analysis</Link>
        </nav>
      </div>

      {/* Main Content */}
      <div className="w-3/4 p-6 overflow-y-auto">
        <h1 className="text-2xl font-bold mb-6">Vulnerability Analysis</h1>

      <div className="space-y-8">

        {/* Vo Section */}
        <TableCard title="Organization Vulnerabilities (Vo)">
            <thead>
              <HeadRow cells={["Vulnerability ID","CVSS Score (0-10)","Affected System","Status"]}/>
            </thead>
            <tbody>
              {INTERNAL_VULNERABILITIES.map((v,i)=>(
                <tr key={v.id} className="border-t border-gray-600">
                  <Td>{v.id}</Td>
                  <Td>{v.cvss}</Td>
                  <Td>{v.system}</Td>
                  <Td>
                    <select
                      value={statuses[i]}
                      onChange={e=>{
                        const copy=[...statuses];copy[i]=e.target.value;setStatuses(copy);
                      }}
                      className={`px-2 py-1 rounded ${statusColor(statuses[i])}`}
                    >
                      {["Active","Patched","In Progress"].map(s=><option key={s}>{s}</option>)}
                    </select>
                  </Td>
                </tr>
              ))}
            </tbody>
          </TableCard>

        {/* Vt Section (external) */}
<TableCard title="Threat Actor Known Exploits (Vt)">
            <thead>
              <HeadRow cells={["Vulnerability ID","Attack Pattern","Tool/Malware Used"]}/>
            </thead>
            <tbody>
              {EXTERNAL_EXPLOITS.map(e=>(
                <tr key={e.id} className="border-t border-gray-600">
                  <Td>{e.id}</Td><Td>{e.pattern}</Td><Td>{e.tool}</Td>
                </tr>
              ))}
            </tbody>
          </TableCard>

        {/* Vtn Section */}
          <TableCard title="Common Vulnerabilities (Vtn = Vo ∩ Vt)">
            <thead>
              <HeadRow cells={["Vulnerability ID","CVSS Score","Affected System","Status","VL","LEF Value"]}/>
            </thead>
            <tbody>
              {common.map(v=>{
                const vl  = vlValues[v.id] ?? 0;
                const lef = calcLEF(vl);
                return (
                  <tr key={v.id} className="border-t border-gray-600">
                    <Td>{v.id}</Td>
                    <Td>{v.cvss}</Td>
                    <Td>{v.system}</Td>
                    <Td>{v.status}</Td>
                    <Td>
                      <select
                        value={vl}
                        onChange={e=>setVlValues(p=>({...p,[v.id]:parseFloat(e.target.value)}))}
                        className="bg-blue-700 rounded px-2 py-1 text-sm"
                      >
                        {VL_OPTS.map(o=><option key={o.val} value={o.val}>{o.lbl}</option>)}
                      </select>
                    </Td>
                    <Td className="font-semibold text-green-400">{lef.toFixed(4)}</Td>
                  </tr>
                );
              })}
            </tbody>
          </TableCard>

        {/* Total LEF */}
        <Card className="p-6 mb-8 bg-gray-800">
          <h2 className="text-xl text-red-500 font-semibold mb-4">Total LEF Value</h2>
          <p className="text-red-500 text-2xl font-bold">Total LEF = {totalLEF.toFixed(4)}</p>
        </Card>
      </div>
     </div>
    </div>
  );
}

function TableCard({ title, children }: { title: string; children: React.ReactNode }) {
  return (
    <Card className="bg-white text-black p-4 min-w-[340px] shadow">
      <h2 className="text-lg font-bold mb-2">{title}</h2>
      <div className="overflow-x-auto">
        {/* 头、体来自父组件 */}
        <table className="w-full text-sm border border-gray-300">{children}</table>
      </div>
    </Card>
  );
}

const Td = ({ children }: { children: React.ReactNode }) => (
  <td className="px-2 py-1 border-t border-gray-300">{children}</td>
);

const HeadRow = ({ cells }: { cells: string[] }) => (
  <tr className="bg-gray-200 border-b border-gray-300">
    {cells.map((c) => (
      <th key={c} className="px-2 py-1 text-left font-semibold">
        {c}
      </th>
    ))}
  </tr>
);
