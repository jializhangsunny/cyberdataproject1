"use client";

import React, { useState, useEffect } from "react";
import { Card } from "@/components/ui/card";
import Link from "next/link";
import { useAppContext } from "@/context/appcontext";
import { useAuth } from "@/context/authContext";
import organizationService from "@/services/organizations";
import exploitService from "@/services/exploits";
import threatActorService from "@/services/threatActors";
import { useUserPreferences } from "@/context/userPreferencesContext";

import OnboardingTour from "@/components/OnboardingTour";
import type { StepType } from "@reactour/tour";

const vulnSteps : StepType[] = [
  {
    selector: "#tour-vuln-internal",
    content: "Select Status of your organization internal vulnerability", position: "top",
  },
  {
    selector: "#tour-vuln-common",
    content: "Filter by choose Vulnerability Level",
    position: "top",
  },
  {
    selector: "#tour-vuln-score",
    content: "Overall LEF score for your org.",
    position: "top",
  },
];

interface VlOption {
  lbl: string;
  val: number;
}

interface Organization {
  id: string;
  name: string;
  location: string;
  sector: string;
  vulnerabilities?: OrganizationVulnerability[];
}

interface OrganizationVulnerability {
  id: string;
  vulnerabilityId: string;
  affectedSystem: string;
  status: string;
  vulnerabilityLevel: string;
}

interface ThreatActor {
  id: string;
  name: string;
  sophisticationLevel: string;
  resourceLevel: string;
  location: string;
  sector: string;
}

interface Exploit {
  id: string;
  vulnerabilityId: string;
  attackPattern: string;
  toolMalwareUsed: string;
  cvssScore: number;
}

interface OverlappingVulnerability {
  vulnerabilityId: string;
  organizationVulnerability: {
    id: string;
    affectedSystem: string;
    status: string;
    vulnerabilityLevel: string;
  };
  threatActorExploits: Array<{
    id: string;
    threatActor: {
      id: string;
      name: string;
    };
    attackPattern: string;
    toolMalwareUsed: string;
    cvssScore: number;
  }>;
}

interface VulnerabilityLevelPreference {
  vulnerabilityId: string;
  vulnerabilityLevel: number;
  // add other properties as needed
}

interface OrganizationVulnerabilityStatusPreference {
  organizationVulnerabilityId: string;
  status: string;
  // add other properties as needed
}

const VL_OPTS: VlOption[] = [
  { lbl: "Very Low",  val: 0   },
  { lbl: "Low",       val: 0.2 },
  { lbl: "Moderate",  val: 0.5 },
  { lbl: "High",      val: 0.8 },
  { lbl: "Very High", val: 1   },
];

// Color mapping for status
const statusColor = (s: string): string =>
    s === "Patched"
    ? "bg-green-100 text-green-700"
    : s === "In Progress"
    ? "bg-yellow-100 text-yellow-700"
    : "bg-red-100 text-red-700"; // Active

interface TdProps extends React.TdHTMLAttributes<HTMLTableCellElement> {
  children: React.ReactNode;
  className?: string;
}

const Td: React.FC<TdProps> = ({ children, className = "", ...rest }) => (
  <td
    {...rest}
    className={`px-2 py-1 border-t border-gray-300 ${className}`}
  >
    {children}
  </td>
);

export default function VulnerabilityAnalysisClient() {
  

  const { tefValue, setTefValue, settotalLef, selectedThreatActorId, setSelectedThreatActorId } = useAppContext();
  const { user, logout } = useAuth();
  
  // State for backend data
  const [userOrganization, setUserOrganization] = useState<Organization | null>(null);
  const [threatActors, setThreatActors] = useState<ThreatActor[]>([]);
  const [orgVulnerabilities, setOrgVulnerabilities] = useState<OrganizationVulnerability[]>([]);
  const [threatActorExploits, setThreatActorExploits] = useState<Exploit[]>([]);
  const [overlappingVulnerabilities, setOverlappingVulnerabilities] = useState<OverlappingVulnerability[]>([]);
  const [error, setError] = useState<string | null>(null);
  const [isInitialLoading, setIsInitialLoading] = useState<boolean>(true);
  const [isLoadingOverlapping, setIsLoadingOverlapping] = useState<boolean>(false);
  
  // State for VL values and status changes
  const [vlValues, setVlValues] = useState<{ [key: string]: number }>({});
  const [statusChanges, setStatusChanges] = useState<{ [key: string]: string }>({});
  
  // Guide state
  const [showGuide, setShowGuide] = useState<boolean>(false);

  // new vuln form
  const [showAddVulnForm, setShowAddVulnForm] = useState(false);
  const [newVulnerability, setNewVulnerability] = useState({
    vulnerabilityId: '',
    affectedSystem: '',
    status: 'Active',
    vulnerabilityLevel: 'Moderate'
  });
const [isAddingVuln, setIsAddingVuln] = useState(false);

  // user preferences context
  const [saveLoading, setSaveLoading] = useState<boolean>(false);
  const [hasLoadedPreferences, setHasLoadedPreferences] = useState<Boolean>(false);

  const {
    preferences,
    loading: preferencesLoading,
    error: preferencesError,
    updatePreferences,
    loadPreferencesForThreatActor,
    loadAllUserPreferences,
    hasLoadedAllPreferences,
    vulnerabilities,
    commonVulnerabilitiesLevel = [],
    vulnerabilityLevelPreferences = [], // Default empty array
    organizationVulnerabilityStatusPreferences = [], // Default empty array
    getCommonVulnerabilityLevel
  } = useUserPreferences();

  useEffect(() => {
    if (user?.id) {
      console.log('Loading all preferences for user:', user.id);
      loadAllUserPreferences(user.id);
    }
  }, [user?.id, loadAllUserPreferences]);

  useEffect(() => {
    if (user?.id && selectedThreatActorId) {
      loadPreferencesForThreatActor(user.id, selectedThreatActorId);
    }
  }, [user?.id, selectedThreatActorId, loadPreferencesForThreatActor]);

  const handleAddVulnerability = async () => {
  if (!userOrganization?.id || !newVulnerability.vulnerabilityId || !newVulnerability.affectedSystem) {
    alert('Please fill in all required fields');
    return;
  }

  setIsAddingVuln(true);
    try {
      await organizationService.addVulnerability(userOrganization.id, newVulnerability);
      
      // Reset form
      setNewVulnerability({
        vulnerabilityId: '',
        affectedSystem: '',
        status: 'Active',
        vulnerabilityLevel: 'Moderate'
      });
      setShowAddVulnForm(false);
      
      // Reload organization data to get updated vulnerabilities
      await loadOrganizationData();
    } catch (error) {
      console.error('Error adding vulnerability:', error);
      alert('Failed to add vulnerability. Please try again.');
    } finally {
      setIsAddingVuln(false);
    }
  };

  const handleCancelAddVulnerability = () => {
    setNewVulnerability({
      vulnerabilityId: '',
      affectedSystem: '',
      status: 'Active',
      vulnerabilityLevel: 'Moderate'
    });
    setShowAddVulnForm(false);
  };

  // Initialize selectedThreatActorId from localStorage if not set
  useEffect(() => {
    if (!selectedThreatActorId && threatActors.length > 0) {
      setSelectedThreatActorId(threatActors[0].id);
    }
  }, [threatActors, selectedThreatActorId, setSelectedThreatActorId]);
  
  // Load initial data
  useEffect(() => {
    const loadInitialData = async () => {
      try {
        setError(null);

        // Load threat actors
        const threatActorsData = await threatActorService.getAll();
        setThreatActors(threatActorsData);

        // Load user's organization if they have one
        if (user?.organization?.id) {
          const orgData = await organizationService.getById(user.organization.id);
          setUserOrganization(orgData);
        } else {
          setError("You are not associated with any organization. Please contact your administrator.");
          return;
        }
      } catch (err: any) {
        console.error("Error loading initial data:", err);
        setError(err.message || "Failed to load data");
      } finally {
        setIsInitialLoading(false);
      }
    };
    
    if (user) {
      loadInitialData();
    }
  }, [user]);

  // Load organization vulnerabilities when organization is available
  useEffect(() => {
    if (userOrganization && !preferencesLoading) {
      console.log('Loading organization data (triggered once)...');
      loadOrganizationData();
    }
  }, [userOrganization?.id, preferencesLoading]); // Only depend on userOrganization.id

  // Load overlapping vulnerabilities when organization and threat actor context changes
  useEffect(() => {
    if (userOrganization) {
      loadOverlappingVulnerabilities();
    }
  }, [userOrganization?.id, selectedThreatActorId]); // Use userOrganization.id instead of entire object

  // Load exploits when threat actor changes
    useEffect(() => {
      loadThreatActorExploits();
    }, [selectedThreatActorId]);

  const handleRemoveVulnerability = async (vulnerabilityId: any) => {
    if (!userOrganization?.id) return;
    
    if (!confirm('Are you sure you want to remove this vulnerability?')) {
      return;
    }
    
    try {
      // Pass organizationId as first param, vulnerabilityId as second
      await organizationService.removeVulnerability(userOrganization.id, vulnerabilityId);
      await loadOrganizationData(); // Reload to get updated list
    } catch (error) {
      console.error('Error removing vulnerability:', error);
      alert('Failed to remove vulnerability. Please try again.');
    }
  };

const loadOrganizationData = async () => {
  if (!userOrganization) return;
  
  try {
    // Refresh organization data to get latest vulnerabilities
    const orgData = await organizationService.getById(userOrganization.id);
    setUserOrganization(orgData);
    
    const vulnerabilities = orgData.vulnerabilities || [];
    
    // Make sure to set the org vulnerabilities
    setOrgVulnerabilities(vulnerabilities);
    
    // Initialize VL values and status changes
    const initialVlValues: { [key: string]: number } = {};
    const initialStatusChanges: { [key: string]: string } = {};
    
    if (Array.isArray(vulnerabilities) && vulnerabilities.length > 0) {
      vulnerabilities.forEach((vuln) => {
        // Check if user has saved a preference for this vulnerability
        const savedLevel = getCommonVulnerabilityLevel(vuln.vulnerabilityId);
        
        if (savedLevel) {
          // Convert string level to numeric value
          const levelMap = {
            'Very High': 1,
            'High': 0.8,
            'Moderate': 0.5,
            'Low': 0.2,
            'Very Low': 0
          };
          initialVlValues[vuln.vulnerabilityId] = levelMap[savedLevel as keyof typeof levelMap] ?? 0.5;
        } else {
          // Use default calculation as before
          let defaultVl = 0.5;
          if (vuln.status === "Patched") {
            defaultVl = 0;
          } else if (vuln.status === "Active") {
            switch (vuln.vulnerabilityLevel) {
              case "Very High": defaultVl = 1; break;
              case "High": defaultVl = 0.8; break;
              case "Moderate": defaultVl = 0.5; break;
              case "Low": defaultVl = 0.2; break;
              case "Very Low": defaultVl = 0; break;
              default: defaultVl = 0.5;
            }
          } else if (vuln.status === "In Progress") {
            defaultVl = 0.5;
          }
          initialVlValues[vuln.vulnerabilityId] = defaultVl;
        }
        
        // Status remains the same
        initialStatusChanges[vuln.id] = vuln.status;
      });
    } else {
      console.log('No vulnerabilities found or vulnerabilities is not an array');
    }
    
    setVlValues(initialVlValues);
    setStatusChanges(initialStatusChanges);
    setHasLoadedPreferences(true);
    
  } catch (error: any) {
    console.error("Error loading organization data:", error);
    setError(error.message || "Failed to load organization data");
    
    // Set empty arrays on error to prevent further errors
    setOrgVulnerabilities([]);
    setVlValues({});
    setStatusChanges({});
    setHasLoadedPreferences(true);
  }
};

  const loadOverlappingVulnerabilities = async () => {
    if (!userOrganization?.id) return;
    
    setIsLoadingOverlapping(true);
    try {
      const overlappingData = await organizationService.getOverlappingVulnerabilities(
        userOrganization.id, 
        selectedThreatActorId ?? null
      );
      
      // Remove duplicates based on vulnerabilityId
      const uniqueOverlapping: OverlappingVulnerability[] = [];
      const seenVulnIds = new Set<string>();
      
      (overlappingData.overlappingVulnerabilities || []).forEach((overlap: OverlappingVulnerability) => {
        if (!seenVulnIds.has(overlap.vulnerabilityId)) {
          seenVulnIds.add(overlap.vulnerabilityId);
          uniqueOverlapping.push(overlap);
        }
      });
      
      setOverlappingVulnerabilities(uniqueOverlapping);
    } catch (error: any) {
      console.error("Error loading overlapping vulnerabilities:", error);
      // Don't clear the array on error, keep previous data
    } finally {
      setIsLoadingOverlapping(false);
    }
  };

  const loadThreatActorExploits = async () => {
    try {
      if (!selectedThreatActorId) {
        const allExploits = await exploitService.getAll();
        setThreatActorExploits(allExploits);
      } else {
        const exploits = await exploitService.getByThreatActor(selectedThreatActorId);
        setThreatActorExploits(exploits);
      }
    } catch (error: any) {
      console.error("Error loading threat actor exploits:", error);
    }
  };

  // Calculate individual LEF values: VL × TEF for each vulnerability
  const lefArr = overlappingVulnerabilities.map(overlap => {
    const vl = vlValues[overlap.vulnerabilityId] ?? 0; // VL value from dropdown (0, 0.2, 0.5, 0.8, 1)
    return vl * tefValue; // LEF = VL × TEF
  });
  
  // Total LEF = Sum of all individual LEF values ÷ Number of vulnerabilities
  const totalLEF = lefArr.length > 0 
    ? lefArr.reduce((sum, v) => sum + v, 0) / lefArr.length
    : 0;

  useEffect(() => {
    settotalLef(totalLEF);
  }, [totalLEF, settotalLef]);

  const handleVLChange = async (vulnerabilityId: string, value: number) => {
    setVlValues(prev => ({ ...prev, [vulnerabilityId]: value }));
    await updatePreferences({
      
    })
  };

  const handleStatusChange = async (orgVulnId: string, newStatus: string) => {
    if (!userOrganization) return;
    
    try {
      // Update in backend first
      await organizationService.updateVulnerability(userOrganization.id, orgVulnId, {
        status: newStatus
      });
      
      // Update local state only after successful backend update
      setStatusChanges(prev => ({ ...prev, [orgVulnId]: newStatus }));
      
    } catch (error: any) {
      console.error("Error updating vulnerability status:", error);
      setError("Failed to update vulnerability status");
    }
  };

    const handleSavePreferences = async () => {
      if (!user?.id || !selectedThreatActorId) return;
      
      setSaveLoading(true);
      try {
        // Convert VL values back to string format for commonVulnerabilitiesLevel
        const levelMap = {
          1: 'Very High',
          0.8: 'High', 
          0.5: 'Moderate',
          0.2: 'Low',
          0: 'Very Low'
        };
        
        const commonVulnerabilitiesLevel = Object.entries(vlValues).map(([vulnerabilityId, level]) => ({
          vulnerabilityId,
          level: levelMap[level as keyof typeof levelMap] || 'Moderate'
        }));

        // Update preferences using existing updatePreferences function
        await updatePreferences({
          commonVulnerabilitiesLevel
        });

      } catch (err) {
        console.error('Failed to save vulnerability preferences:', err);
        alert('Failed to save preferences. Please try again.');
      } finally {
        setSaveLoading(false);
      }
    };

  useEffect(() => {
    // Reset loaded preferences flag when threat actor changes
    if (selectedThreatActorId) {
      setHasLoadedPreferences(false);
    }
  }, [selectedThreatActorId]);

  // Update when preferences are loaded
  useEffect(() => {
    if (preferences && userOrganization && !hasLoadedPreferences) {
      // Reload organization data to apply preferences
      loadOrganizationData();
    }
  }, [preferences, userOrganization, hasLoadedPreferences]);


  const handleThreatActorChange = (threatActorId: string) => {
    setSelectedThreatActorId(threatActorId || null);
  };

  const getCurrentStatus = (vulnerability: OrganizationVulnerability): string => {
    return statusChanges[vulnerability.id] || vulnerability.status;
  };

  const getCurrentStatusForOverlapping = (overlap: OverlappingVulnerability): string => {
  // Use overlap.vulnerabilityId instead of orgVuln.vulnerabilityId
  const matchingOrgVuln = orgVulnerabilities.find(ov => 
    ov.vulnerabilityId === overlap.vulnerabilityId && 
    ov.affectedSystem === overlap.organizationVulnerability.affectedSystem
  );
  
  if (matchingOrgVuln) {
    return statusChanges[matchingOrgVuln.id] || overlap.organizationVulnerability.status;
  }
  
  return overlap.organizationVulnerability.status;
};

  // Get selected threat actor name for display
  const selectedThreatActorName = threatActors.find(ta => ta.id === selectedThreatActorId)?.name || "All Threat Actors";

  // Show initial loading state
  if (isInitialLoading) {
    return (
      <div className="flex h-screen bg-gray-900 text-white items-center justify-center">
        <div className="text-2xl">Loading...</div>
      </div>
    );
  }

  // Show error state
  if (error && !userOrganization) {
    return (
      <div className="flex h-screen bg-gray-900 text-white items-center justify-center">
        <div className="text-center">
          <div className="text-2xl text-red-500 mb-4">Error: {error}</div>
          <button 
            onClick={() => window.location.reload()} 
            className="px-4 py-2 bg-blue-600 rounded hover:bg-blue-700"
          >
            Retry
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="flex h-screen bg-gray-900 text-white">
      {/* Sidebar */}
      <div className="w-1/4 bg-gray-800 p-6">
        <h2 className="text-2xl font-bold mb-4">Navigation</h2>
        <nav className="flex flex-col space-y-4">
          <Link href="/" className="p-3 bg-gray-700 text-gray-300 rounded-md hover:bg-gray-600">
            Threat Actor Analysis
          </Link>
          <Link href="/vulnerabilityanalysis" className="p-3 bg-blue-500 text-white rounded-md hover:bg-blue-600">
            Vulnerability Analysis
          </Link>
          <Link href="/riskanalysis" className="p-3 bg-gray-700 text-gray-300 rounded-md hover:bg-gray-600">
            Risk Analysis
          </Link>
          <Link href="/securitycontrolsanalysis" className="p-3 bg-gray-700 text-gray-300 rounded-md hover:bg-gray-600">
            Security Controls Analysis and ROSI Calculation
          </Link>

          <div className="mb-6 p-4 bg-gray-700 rounded-lg">
            <div className="flex items-center justify-between">
              <div>
                <h3 className="text-lg font-semibold text-white">{user?.name}</h3>
                <p className="text-sm text-gray-300">{user?.email}</p>
                <span className={`inline-block px-2 py-1 text-xs rounded mt-1 ${
                  user?.type === 'admin' ? 'bg-red-600 text-white' :
                  user?.type === 'analyst' ? 'bg-blue-600 text-white' : 'bg-green-600 text-white'
                }`}>
                  {user?.type?.toUpperCase()}
                </span>
              </div>
              <button
                onClick={() => {
                  if (window.confirm('Are you sure you want to logout?')) {
                    logout();
                  }
                }}
                className="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors"
                title="Logout"
              >
                Logout
              </button>
            </div>
          </div>

        </nav>
      </div>

      {/* Main Content */}
      <div className="w-3/4 p-6 space-y-8 overflow-y-auto">
        <h1 className="text-2xl font-bold mb-6">Vulnerability Analysis</h1>

          <div>
            <Card className="p-4 bg-gray-800">
              <h2 className="text-xl font-semibold mb-2 text-white">Change Threat Actor</h2>
              <select
                value={selectedThreatActorId || ""}
                onChange={(e) => handleThreatActorChange(e.target.value)}
                className="w-full p-2 border rounded-md bg-white text-black"
              >
                <option value="">All threat actors</option>
                {threatActors.map(ta => (
                  <option key={ta.id} value={ta.id}>{ta.name}</option>
                ))}
              </select>
            </Card>
          </div>

        {/* Threat Actor Name */}
        <Card className="p-4 text-center bg-gray-800 mb-6">
          <h1 className="text-3xl text-white font-bold">
            Threat Actor Name: {selectedThreatActorName}
          </h1>
        </Card>

        {/* Organization and Threat Actor Selection */}
        <div className="mb-6 space-y-4">
          {/* Organization Display (Read-only) */}
          {/* <div>
            <label className="block text-sm font-medium mb-2">Your Organization:</label>
            <div className="bg-gray-700 text-white px-3 py-2 rounded-md w-64 border border-gray-600">
              {userOrganization?.name || "No organization assigned"}
            </div>
            <p className="text-xs text-gray-400 mt-1">
              You can only view vulnerabilities for your assigned organization
            </p>
          </div> */}
          


          {/* Current Analysis Context */}
          <div className="p-4 bg-gray-800 rounded-md border border-gray-600">
            <h3 className="text-lg font-semibold mb-2 text-white">Analysis Context</h3>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
              <div>
                <span className="text-gray-400">Organization:</span>
                <p className="text-white font-medium">
                  {userOrganization?.name || "None assigned"}
                </p>
              </div>
              <div>
                <span className="text-gray-400">Threat Actor:</span>
                <p className="text-white font-medium">{selectedThreatActorName}</p>
              </div>
              <div>
                <span className="text-gray-400">TEF Value:</span>
                <p className="text-white font-medium">{tefValue.toFixed(6)}</p>
              </div>
            </div>
          </div>
        </div>

        <div id="tour-vuln-internal" className="space-y-8">
  {/* Organization Vulnerabilities Section */}
  {userOrganization && (
    <TableCard title={`${userOrganization.name} Vulnerabilities (Vo)`}>
      <thead>
        <HeadRow cells={["Vulnerability ID", "Affected System", "Status", "Actions"]} />
      </thead>
      <tbody>
        {orgVulnerabilities.length > 0 ? (
          orgVulnerabilities.map((vuln) => (
            <tr key={vuln.id} className="border-t border-gray-600">
              <Td>{vuln.vulnerabilityId}</Td>
              <Td>{vuln.affectedSystem}</Td>
              <Td className={statusColor(getCurrentStatus(vuln))}>
                <select
                  value={getCurrentStatus(vuln)}
                  onChange={(e) => handleStatusChange(vuln.id, e.target.value)}
                  className="bg-transparent outline-none px-2 py-1"
                >
                  {["Active", "Patched", "In Progress"].map((s) => (
                    <option key={s} value={s}>{s}</option>
                  ))}
                </select>
              </Td>
              <Td>
                <button
                  onClick={() => handleRemoveVulnerability(vuln.id)}
                  className="text-red-600 hover:text-red-800 text-sm px-2 py-1"
                  title="Remove vulnerability"
                >
                  Remove
                </button>
              </Td>
            </tr>
          ))
        ) : (
          <tr className="border-t border-gray-600">
            <Td colSpan={4} className="text-center text-gray-500">
              No vulnerabilities found for your organization
            </Td>
          </tr>
        )}
        
        {/* Add Vulnerability Form Row */}
        {showAddVulnForm && (
          <tr className="border-t border-gray-600 bg-blue-50">
            <Td>
              <input
                type="text"
                value={newVulnerability.vulnerabilityId}
                onChange={(e) => setNewVulnerability(prev => ({...prev, vulnerabilityId: e.target.value}))}
                placeholder="e.g., CVE-2023-1234"
                className="w-full px-2 py-1 border rounded text-sm"
              />
            </Td>
            <Td>
              <input
                type="text"
                value={newVulnerability.affectedSystem}
                onChange={(e) => setNewVulnerability(prev => ({...prev, affectedSystem: e.target.value}))}
                placeholder="e.g., Web Server"
                className="w-full px-2 py-1 border rounded text-sm"
              />
            </Td>
            <Td>
              <select
                value={newVulnerability.status}
                onChange={(e) => setNewVulnerability(prev => ({...prev, status: e.target.value}))}
                className="w-full px-2 py-1 border rounded text-sm"
              >
                {["Active", "Patched", "In Progress"].map((s) => (
                  <option key={s} value={s}>{s}</option>
                ))}
              </select>
            </Td>
            <Td>
              <div className="flex gap-1">
                <button
                  onClick={handleAddVulnerability}
                  disabled={isAddingVuln}
                  className="bg-green-600 text-white px-2 py-1 rounded text-sm hover:bg-green-700 disabled:bg-gray-400"
                >
                  {isAddingVuln ? 'Adding...' : 'Add'}
                </button>
                <button
                  onClick={handleCancelAddVulnerability}
                  className="bg-gray-600 text-white px-2 py-1 rounded text-sm hover:bg-gray-700"
                >
                  Cancel
                </button>
              </div>
            </Td>
          </tr>
        )}
      </tbody>
      
      {/* Add Vulnerability Button */}
      {/* {!showAddVulnForm && (
        <div className="mt-4">
          <button
            onClick={() => setShowAddVulnForm(true)}
            className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm"
          >
            + Add New Vulnerability
          </button>
        </div>
      )} */}
      {!showAddVulnForm && (
  <tfoot>
    <tr className="border-t-2 border-gray-400">
      <td colSpan={4} className="px-2 py-2 text-center bg-gray-50">
        <button
          onClick={() => setShowAddVulnForm(true)}
          className="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-sm inline-flex items-center gap-1"
        >
          <span className="text-xs">+</span>
          Add New Vulnerability
        </button>
      </td>
    </tr>
  </tfoot>
)}
      
    </TableCard>
  )}


          {/* Threat Actor Exploits Section */}
          <TableCard title={`Threat Actor Known Exploits (Vt) - ${selectedThreatActorName}`}>
            <thead>
              <HeadRow cells={["Vulnerability ID", "Attack Pattern", "Tool/Malware Used", "CVSS Score"]} />
            </thead>
            <tbody>
              {threatActorExploits.length > 0 ? (
                threatActorExploits.map(exploit => (
                  <tr key={exploit.id} className="border-t border-gray-600">
                    <Td>{exploit.vulnerabilityId || "N/A"}</Td>
                    <Td>{exploit.attackPattern || "N/A"}</Td>
                    <Td>{exploit.toolMalwareUsed || "N/A"}</Td>
                    <Td>{exploit.cvssScore || "N/A"}</Td>
                  </tr>
                ))
              ) : (
                <tr className="border-t border-gray-600">
                  <Td colSpan={4} className="text-center text-gray-500">
                    No exploits found for the selected threat actor
                  </Td>
                </tr>
              )}
            </tbody>
          </TableCard>
  </div>

          {/* Overlapping Vulnerabilities Section - Always render, conditionally show content */}
          <div id="tour-vuln-common">
          <TableCard  title={`Common Vulnerabilities (Vtn = Vo ∩ Vt) - ${overlappingVulnerabilities.length} unique vulnerabilities`}>
            <thead>
              <HeadRow cells={["Vulnerability ID", "Affected System", "Status", "Vulnerability Level (VL)", "LEF Value", "Threat Actors"]} />
            </thead>
            <tbody>
              {isLoadingOverlapping ? (
                <tr className="border-t border-gray-600">
                  <Td colSpan={6} className="text-center text-gray-500">
                    Loading overlapping vulnerabilities...
                  </Td>
                </tr>
              ) : overlappingVulnerabilities.length > 0 ? (
                  // In the overlapping vulnerabilities mapping, update the VL calculation:
                  overlappingVulnerabilities.map(overlap => {
                    const currentStatus = getCurrentStatusForOverlapping(overlap);
                    let vl = vlValues[overlap.vulnerabilityId] ?? 0;
                    
                    // If you want VL to automatically update based on status changes:
                    if (currentStatus === "Patched") {
                      vl = 0; // Override VL to 0 for patched vulnerabilities
                    }
                    
                    const orgVuln = overlap.organizationVulnerability;
                    const threatActorCount = overlap.threatActorExploits?.length || 0;
                    
                    return (
                      <tr key={overlap.vulnerabilityId} className="border-t border-gray-600">
                        <Td>{overlap.vulnerabilityId}</Td>
                        <Td>{orgVuln.affectedSystem}</Td>
                        <Td className={statusColor(getCurrentStatusForOverlapping(overlap))}>
                          {getCurrentStatusForOverlapping(overlap)}
                        </Td>
                        <Td>
                          <select
                            value={vl}
                            onChange={e => handleVLChange(overlap.vulnerabilityId, parseFloat(e.target.value))}
                            className="bg-blue-700 rounded px-2 py-1 text-sm text-white"
                            disabled={currentStatus === "Patched"} // Optionally disable if patched
                          >
                            {VL_OPTS.map(o => <option key={o.val} value={o.val}>{o.lbl}</option>)}
                          </select>
                        </Td>
                        <Td className={(vl * (tefValue || 0)) >= 1.0 ? "font-bold text-red-300" : ""}>
                          {(vl * (tefValue || 0)).toFixed(8)}
                        </Td>
                        <Td>
                          <span className="text-xs bg-gray-600 px-2 py-1 rounded">
                            {threatActorCount} exploit{threatActorCount !== 1 ? 's' : ''}
                          </span>
                        </Td>
                      </tr>
                    );
                  })
              ) : (
                <tr className="border-t border-gray-600">
                  <Td colSpan={6} className="text-center text-gray-500">
                    {userOrganization ? 
                      `No overlapping vulnerabilities found between ${userOrganization.name} and ${selectedThreatActorName}.` :
                      "No data available"
                    }
                  </Td>
                </tr>
              )}
            </tbody>
          </TableCard>
</div>

          {/* Total LEF */}
          <Card id="tour-vuln-score" className="p-6 mb-8 bg-red-700">
            <h2 className="text-xl font-semibold mb-4">Total LEF Value (Average)</h2>
            <div className="space-y-2">
              <p className="text-white text-2xl font-bold">Total LEF = {totalLEF.toFixed(3)}</p>
              <p className="text-sm text-gray-300">
                Calculated as average of {overlappingVulnerabilities.length} vulnerability LEF scores
              </p>
              <p className="text-xs text-gray-400">
                Formula: Sum(VL₁×TEF, VL₂×TEF, ..., VLₙ×TEF) ÷ Number of vulnerabilities
              </p>
            </div>
          </Card>
          {hasLoadedPreferences && overlappingVulnerabilities.length > 0 && (
            <Card className="p-6 bg-green-800 border-green-600">
              <div className="text-center">
                <h2 className="text-2xl font-semibold text-white mb-4">Save Vulnerability Preferences</h2>
                <p className="text-green-100 mb-6">
                  Save your vulnerability level assessments and organization vulnerability status changes for <strong>{selectedThreatActorName}</strong>. 
                  These preferences will be preserved for future sessions.
                </p>
                
                <button
                  onClick={handleSavePreferences}
                  disabled={saveLoading || !selectedThreatActorId}
                  className={`px-8 py-4 text-xl font-semibold rounded-lg transition-all duration-200 ${
                    saveLoading || !selectedThreatActorId
                      ? 'bg-gray-600 text-gray-400 cursor-not-allowed'
                      : 'bg-green-600 hover:bg-green-500 text-white transform hover:scale-105 shadow-lg hover:shadow-xl'
                  }`}
                >
                  {saveLoading ? (
                    <div className="flex items-center justify-center">
                      <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-white mr-3"></div>
                      Saving...
                    </div>
                  ) : (
                    'SAVE VULNERABILITY PREFERENCES'
                  )}
                </button>
                
                {!selectedThreatActorId && (
                  <p className="text-sm text-red-300 mt-2">
                    Please select a threat actor before saving preferences.
                  </p>
                )}
              </div>
            </Card>
          )}

        {/* Preferences Status Display */}
        {preferences && hasLoadedPreferences && (
          <Card className="p-4 bg-gray-800 border-gray-600">
            <h3 className="text-lg font-semibold text-white mb-2">
              Current Vulnerability Preferences for {selectedThreatActorName}
            </h3>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
              <div>
                <span className="text-gray-300">Threat Actor:</span>
                <span className="text-white ml-2">{selectedThreatActorName}</span>
              </div>
              <div>
                <span className="text-gray-300">Has Preferences:</span>
                <span className="text-white ml-2">{preferences.threatActorId ? 'Yes' : 'No'}</span>
              </div>
              <div>
                <span className="text-gray-300">VL Preferences:</span>
                <span className="text-white ml-2">{vulnerabilityLevelPreferences.length}</span>
              </div>
              <div>
                <span className="text-gray-300">Status Preferences:</span>
                <span className="text-white ml-2">{organizationVulnerabilityStatusPreferences.length}</span>
              </div>
            </div>
            <div className="mt-4 text-xs text-gray-400">
              Last updated: {preferences.updatedAt ? new Date(preferences.updatedAt).toLocaleString() : 'Never'}
            </div>
          </Card>
        )}


      </div>

      
      
      {/* Floating toggle button */}
      <button
        onClick={() => setShowGuide(true)}
        className="fixed bottom-6 right-6 z-50 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full shadow-lg"
      >
        VL Assessment Reference Guide
      </button>

      {/* VL Assessment Reference Guide */}
      {showGuide && (
        <div className="fixed inset-0 z-40 flex items-center justify-center">
          <div
            className="absolute inset-0 bg-black/50"
            onClick={() => setShowGuide(false)}
          />
          <div className="relative z-50 w-[90%] max-w-md bg-white text-black rounded-lg shadow-xl p-6 space-y-4">
            <h3 className="text-xl font-bold text-center">VL Assessment Reference Guide</h3>
            <ul className="text-sm list-disc pl-5 space-y-1">
              <li><b>VL = 1</b>: Very High vulnerability level and Status is <b>Active</b></li>
              <li><b>VL = 0.8</b>: High vulnerability level and Status is <b>Active</b></li>
              <li><b>VL = 0.5</b>: Moderate vulnerability level or <b>In Progress</b> status</li>
              <li><b>VL = 0.2</b>: Low vulnerability level</li>
              <li><b>VL = 0</b>: <b>Patched vulnerability</b> or Very Low level</li>
            </ul>
            
            <div className="border-t pt-3">
              <h4 className="font-bold text-sm mb-2">LEF Calculation:</h4>
              <p className="text-xs text-gray-600">
                LEF = min(VL × TEF, 1.0)<br/>
                Total LEF = Average of all individual LEF values
              </p>
            </div>
            
            <button
              onClick={() => setShowGuide(false)}
              className="mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-md"
            >
              Close
            </button>
          </div>
        </div>
      )}

      <OnboardingTour steps={vulnSteps} storageKey="tour_done_vuln" />

    </div>
  );
}

interface TableCardProps {
  title: string;
  children: React.ReactNode;
}

function TableCard({ title, children }: TableCardProps) {
  return (
    <Card className="bg-white text-black p-4 min-w-[340px] shadow">
      <h2 className="text-lg font-bold mb-2">{title}</h2>
      <div className="overflow-x-auto">
        <table className="w-full text-sm border border-gray-300">{children}</table>
      </div>
    </Card>
  );
}

interface HeadRowProps {
  cells: string[];
}

const HeadRow: React.FC<HeadRowProps> = ({ cells }) => (
  <tr className="bg-gray-200 border-b border-gray-300">
    {cells.map((c) => (
      <th key={c} className="px-2 py-1 text-left font-semibold">
        {c}
      </th>
    ))}
  </tr>
);